= Spring Session 与 Spring Security
Rob Winch
:stylesdir: ../
:highlightjsdir: ../js/highlight
:docinfodir: guides

本指南介绍如何将 Spring Session 与 Spring Security 结合使用。  
假设你已经为应用程序配置了 Spring Security。

NOTE: 你可以在 <<security-sample, security 示例应用>> 中找到完整的指南代码。

[#index-link]
link:../index.html[首页]

== 更新依赖项
在使用 Spring Session 之前，必须先更新项目的依赖项。  
如果你使用的是 Maven，请添加以下依赖：

====
.pom.xml
[source,xml]
[subs="verbatim,attributes"]
----
<dependencies>
	<!-- ... -->

	<dependency>
		<groupId>org.springframework.session</groupId>
		<artifactId>spring-session-data-redis</artifactId>
		<version>{spring-session-version}</version>
		<type>pom</type>
	</dependency>
	<dependency>
		<groupId>io.lettuce</groupId>
		<artifactId>lettuce-core</artifactId>
		<version>{lettuce-core-version}</version>
	</dependency>
	<dependency>
		<groupId>org.springframework</groupId>
		<artifactId>spring-web</artifactId>
		<version>{spring-core-version}</version>
	</dependency>
</dependencies>
----
====

ifeval::["{version-snapshot}" == "true"]
由于我们使用的是 SNAPSHOT 版本，需要添加 Spring 快照仓库（Spring Snapshot Maven Repository）。  
请确保你的 pom.xml 文件中包含以下内容：

====
.pom.xml
[source,xml]
----
<repositories>

	<!-- ... -->

	<repository>
		<id>spring-snapshot</id>
		<url>https://repo.spring.io/libs-snapshot</url>
	</repository>
</repositories>
----
====
endif::[]

ifeval::["{version-milestone}" == "true"]
由于我们使用的是里程碑版本（Milestone），需要添加 Spring 里程碑仓库（Spring Milestone Maven Repository）。  
请确保你的 pom.xml 文件中包含以下内容：

====
.pom.xml
[source,xml]
----
<repository>
	<id>spring-milestone</id>
	<url>https://repo.spring.io/libs-milestone</url>
</repository>
----
====
endif::[]

[[security-spring-configuration]]
== Spring 配置

添加必要的依赖后，我们可以创建 Spring 配置。  
该配置的作用是创建一个 Servlet 过滤器（Filter），用于将默认的 `HttpSession` 实现替换为由 Spring Session 支持的实现。  
为此，请添加以下 Spring 配置：

====
[source,java]
----
include::{samples-dir}spring-session-sample-javaconfig-security/src/main/java/sample/Config.java[tags=class]
----

<1> `@EnableRedisHttpSession` 注解会创建一个名为 `springSessionRepositoryFilter` 的 Spring Bean，该 Bean 实现了 `Filter` 接口。  
这个过滤器负责将 `HttpSession` 的实现替换为由 Spring Session 支持的自定义实现。  
在此示例中，Spring Session 使用 Redis 作为后端存储。
<2> 我们创建了一个 `RedisConnectionFactory`，用于连接 Spring Session 到 Redis 服务器。  
此处配置为连接本地主机（localhost）上的默认端口（6379）。  
有关 Spring Data Redis 的更多配置信息，请参阅 {docs-url}/spring-data/data-redis/docs/{spring-data-redis-version}/reference/html/[参考文档]。
====

== Servlet 容器初始化

我们的 <<security-spring-configuration,Spring 配置>> 创建了一个名为 `springSessionRepositoryFilter` 的 Spring Bean，并实现了 `Filter` 接口。  
该 Bean 负责将标准的 `HttpSession` 替换为由 Spring Session 支持的自定义实现。

为了让这个 `Filter` 正常工作，Spring 必须加载我们的 `Config` 类。  
由于我们的应用已通过 `SecurityInitializer` 类加载了 Spring 配置，因此可以将新的配置类加入其中。  
如下所示：

====
.src/main/java/sample/SecurityInitializer.java
[source,java]
----
include::{samples-dir}spring-session-sample-javaconfig-security/src/main/java/sample/SecurityInitializer.java[tags=class]
----
====

最后，我们需要确保 Servlet 容器（例如 Tomcat）在每个请求中都使用我们的 `springSessionRepositoryFilter`。  
**非常重要的一点是：Spring Session 的 `springSessionRepositoryFilter` 必须在 Spring Security 的 `springSecurityFilterChain` 之前执行。**  
这样才能保证 Spring Security 使用的 `HttpSession` 是由 Spring Session 提供支持的。

幸运的是，Spring Session 提供了一个工具类 `AbstractHttpSessionApplicationInitializer`，使这一过程变得简单。  
如下所示：

====
.src/main/java/sample/Initializer.java
[source,java]
----
include::{samples-dir}spring-session-sample-javaconfig-security/src/main/java/sample/Initializer.java[tags=class]
----
====

NOTE: 我们的类名（Initializer）不重要，关键在于继承了 `AbstractHttpSessionApplicationInitializer`。

通过继承 `AbstractHttpSessionApplicationInitializer`，我们确保了名为 `springSessionRepositoryFilter` 的 Spring Bean 在每次请求时都会被注册到 Servlet 容器中，并且在 Spring Security 的 `springSecurityFilterChain` 之前执行。

[[security-sample]]
== `security` 示例应用

本节介绍如何运行和使用 `security` 示例应用。

=== 运行 `security` 示例应用

你可以通过获取 {download-url}[源码] 并执行以下命令来运行示例：

====
----
$ ./gradlew :spring-session-sample-javaconfig-security:tomcatRun
----
====

NOTE: 要使示例正常运行，你必须在本地主机上 https://redis.io/download[安装 Redis 2.8 或更高版本]，并使用默认端口（6379）启动它。  
或者，你可以修改 `RedisConnectionFactory` 指向一个远程 Redis 服务器。  
另一种选择是使用 https://www.docker.com/[Docker] 在本地运行 Redis。  
详细说明请参见 https://hub.docker.com/_/redis/[Docker Redis 仓库]。

完成后，你应该可以通过 http://localhost:8080/ 访问该应用。

=== 探索 `security` 示例应用

现在你可以使用该应用进行测试。输入以下凭据登录：

* *用户名* _user_
* *密码* _password_

点击 *Login* 按钮后，你应该能看到一条消息，表明你已成功以指定用户身份登录。  
此时用户的会话信息存储在 Redis 中，而不是 Tomcat 的 `HttpSession` 实现中。

=== 它是如何工作的？

我们不再使用 Tomcat 的 `HttpSession`，而是将会话数据持久化到 Redis 中。  
Spring Session 将 `HttpSession` 替换为基于 Redis 的实现。  
当 Spring Security 的 `SecurityContextPersistenceFilter` 将 `SecurityContext` 保存到 `HttpSession` 时，实际上这些数据被写入了 Redis。

每当创建一个新的 `HttpSession` 时，Spring Session 会在浏览器中设置一个名为 `SESSION` 的 Cookie，其中包含会话 ID。  
你可以使用 https://developers.google.com/web/tools/chrome-devtools/manage-data/cookies[Chrome] 或 https://developer.mozilla.org/en-US/docs/Tools/Storage_Inspector[Firefox] 查看这些 Cookie。

你可以使用 `redis-cli` 删除会话。例如，在基于 Linux 的系统上，可运行以下命令删除所有键：

====
----
	$ redis-cli keys '*' | xargs redis-cli del
----
====

TIP: Redis 官方文档提供了 https://redis.io/topics/quickstart[安装 redis-cli 的说明]。

另外，你也可以删除特定的会话键。在终端中运行以下命令，并将 `7e8383a4-082c-4ffe-a4bc-c40fd3363c5e` 替换为你浏览器中 `SESSION` Cookie 的实际值：

	$ redis-cli del spring:session:sessions:7e8383a4-082c-4ffe-a4bc-c40fd3363c5e

然后访问 http://localhost:8080/，你会发现当前会话已失效，需要重新登录。