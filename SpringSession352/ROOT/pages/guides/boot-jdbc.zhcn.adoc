= Spring Session - Spring Boot
Rob Winch, Vedran Pavić
:stylesdir: ../
:highlightjsdir: ../js/highlight
:docinfodir: guides

本指南介绍如何在使用 Spring Boot 时，通过 Spring Session 透明地利用关系型数据库来支持 Web 应用程序的 `HttpSession`。

NOTE: 您可以在 <<httpsession-jdbc-boot-sample, httpsession-jdbc-boot 示例应用>> 中找到完整的指南。

[#index-link]
link:../index.html[索引]

== 更新依赖项

在使用 Spring Session 之前，您必须更新项目的依赖项。我们假设您正在开发一个已有的 Spring Boot Web 应用程序。如果您使用 Maven，则需要添加以下依赖项：

====
.pom.xml
[source,xml]
[subs="verbatim,attributes"]
----
<dependencies>
	<!-- ... -->

	<dependency>
		<groupId>org.springframework.session</groupId>
		<artifactId>spring-session-jdbc</artifactId>
	</dependency>
</dependencies>
----
====

Spring Boot 为 Spring Session 模块提供了依赖管理，因此您无需显式声明依赖版本。

// tag::config[]

[[httpsession-jdbc-boot-spring-configuration]]
== Spring Boot 配置

添加所需依赖后，我们可以创建 Spring Boot 的配置。得益于一流的自动配置支持，只需添加依赖，Spring Boot 就会为我们设置好基于关系型数据库的 Spring Session。

如果类路径中仅存在一个 Spring Session 模块，Spring Boot 会自动使用该存储实现。若存在多个实现，则必须选择用于存储会话的 StoreType，如上所示。

在底层，Spring Boot 应用的配置相当于手动添加了 `@EnableJdbcHttpSession` 注解。这将创建一个名为 `springSessionRepositoryFilter` 的 Spring Bean，该 Bean 实现了 `Filter` 接口。此过滤器负责将会话的 `HttpSession` 实现替换为由 Spring Session 支持的实现。

您还可以通过 `application.properties` 进一步自定义配置。以下示例展示了如何操作：

====
.src/main/resources/application.properties
----
server.servlet.session.timeout= # 会话超时时间。若未指定时间单位，默认使用秒。
spring.session.jdbc.initialize-schema=embedded # 数据库模式初始化模式。
spring.session.jdbc.schema=classpath:org/springframework/session/jdbc/schema-@@platform@@.sql # 用于初始化数据库模式的 SQL 文件路径。
spring.session.jdbc.table-name=SPRING_SESSION # 用于存储会话的数据库表名。
----
====

更多详细信息，请参阅 Spring Boot 文档中的 {docs-url}/spring-boot/docs/{spring-boot-version}/reference/htmlsingle/#boot-features-session[Spring Session] 部分。

[[httpsession-jdbc-boot-configuration]]
== 配置 `DataSource`

Spring Boot 会自动创建一个 `DataSource`，连接到嵌入式的 H2 数据库实例，供 Spring Session 使用。在生产环境中，您需要修改配置以连接到实际的关系型数据库。例如，您可以在 `application.properties` 中包含以下内容：

====
.src/main/resources/application.properties
----
spring.datasource.url= # 数据库的 JDBC URL。
spring.datasource.username= # 数据库登录用户名。
spring.datasource.password= # 数据库登录密码。
----
====

更多详细信息，请参阅 Spring Boot 文档中的 {docs-url}/spring-boot/docs/{spring-boot-version}/reference/htmlsingle/#boot-features-configure-datasource[配置 DataSource] 部分。

[[httpsession-jdbc-boot-servlet-configuration]]
== Servlet 容器初始化

我们的 <<httpsession-jdbc-boot-spring-configuration,Spring Boot 配置>> 创建了一个名为 `springSessionRepositoryFilter` 的 Spring Bean，它实现了 `Filter` 接口。`springSessionRepositoryFilter` 负责将会话的 `HttpSession` 替换为由 Spring Session 支持的自定义实现。

为了让这个 `Filter` 正常工作，Spring 需要加载我们的 `Config` 类。最后，我们必须确保 Servlet 容器（如 Tomcat）在每个请求中都使用我们的 `springSessionRepositoryFilter`。幸运的是，Spring Boot 已经为我们自动完成了这两步操作。

// end::config[]

[[httpsession-jdbc-boot-sample]]
== `httpsession-jdbc-boot` 示例应用程序

`httpsession-jdbc-boot` 示例应用程序演示了如何在使用 Spring Boot 时，通过 Spring Session 透明地利用 H2 数据库来支持 Web 应用程序的 `HttpSession`。

[[httpsession-jdbc-boot-running]]
=== 运行 `httpsession-jdbc-boot` 示例应用程序

您可以通过获取 {download-url}[源代码] 并执行以下命令来运行该示例：

====
----
$ ./gradlew :spring-session-sample-boot-jdbc:bootRun
----
====

现在您应该可以通过 http://localhost:8080/ 访问该应用程序。

[[httpsession-jdbc-boot-explore]]
=== 探索安全示例应用程序

现在您可以尝试使用该应用程序。请使用以下凭据登录：

* *用户名* _user_
* *密码* _password_

点击 *登录* 按钮后，您应看到一条消息，表明您已使用上述用户成功登录。用户的会话信息被存储在 H2 数据库中，而不是 Tomcat 的 `HttpSession` 实现中。

[[httpsession-jdbc-boot-how]]
=== 原理是什么？

Spring Session 并不使用 Tomcat 的 `HttpSession`，而是将数据持久化到 H2 数据库中。Spring Session 提供了一个基于关系型数据库的 `HttpSession` 实现。当 Spring Security 的 `SecurityContextPersistenceFilter` 将 `SecurityContext` 保存到 `HttpSession` 时，该上下文会被持久化到 H2 数据库中。

每当创建新的 `HttpSession` 时，Spring Session 会在您的浏览器中创建一个名为 `SESSION` 的 Cookie，其中包含会话的 ID。您可以通过 https://developers.google.com/web/tools/chrome-devtools/manage-data/cookies[Chrome] 或 https://developer.mozilla.org/en-US/docs/Tools/Storage_Inspector[Firefox] 的开发者工具查看这些 Cookie。

您也可以通过访问 H2 数据库控制台（地址：http://localhost:8080/h2-console/，JDBC URL 输入 `jdbc:h2:mem:testdb`）删除会话数据。

然后重新访问 http://localhost:8080/，您会发现当前已不再处于认证状态。