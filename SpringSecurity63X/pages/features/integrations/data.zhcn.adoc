[[data]]
= Spring Data 集成

Spring Security 提供了与 Spring Data 的集成，允许在查询中引用当前用户。将用户包含在查询中不仅有用，而且是必要的，尤其是在支持分页结果时，因为在查询后对结果进行过滤将无法良好地扩展。

[[data-configuration]]
== Spring Data 与 Spring Security 配置

要使用此功能，请添加 `org.springframework.security:spring-security-data` 依赖项，并提供一个类型为 `SecurityEvaluationContextExtension` 的 Bean。在 Java 配置中，如下所示：

[tabs]
======
Java::
+
[source,java,role="primary"]
----
@Bean
public SecurityEvaluationContextExtension securityEvaluationContextExtension() {
	return new SecurityEvaluationContextExtension();
}
----

Kotlin::
+
[source,kotlin,role="secondary"]
----
@Bean
fun securityEvaluationContextExtension(): SecurityEvaluationContextExtension {
    return SecurityEvaluationContextExtension()
}
----
======

在 XML 配置中，如下所示：

[source,xml]
----
<bean class="org.springframework.security.data.repository.query.SecurityEvaluationContextExtension"/>
----

[[data-query]]
== 在 @Query 中使用安全表达式

现在可以在查询中使用 Spring Security。例如：

[tabs]
======
Java::
+
[source,java,role="primary"]
----
@Repository
public interface MessageRepository extends PagingAndSortingRepository<Message,Long> {
	@Query("select m from Message m where m.to.id = ?#{ principal?.id }")
	Page<Message> findInbox(Pageable pageable);
}
----

Kotlin::
+
[source,kotlin,role="secondary"]
----
@Repository
interface MessageRepository : PagingAndSortingRepository<Message?, Long?> {
    @Query("select m from Message m where m.to.id = ?#{ principal?.id }")
    fun findInbox(pageable: Pageable?): Page<Message?>?
}
----
======

此查询会检查 `Authentication.getPrincipal().getId()` 是否等于 `Message` 的接收者 ID。请注意，此示例假设你已自定义了 Principal，使其成为一个具有 `id` 属性的对象。通过暴露 `SecurityEvaluationContextExtension` Bean，所有 xref:servlet/authorization/method-security.adoc#authorization-expressions[常用安全表达式] 均可在查询中使用。