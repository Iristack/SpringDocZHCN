= 方法安全

[[nsa-method-security]]
== `<method-security>`
该元素是为 Spring Security Bean 的方法提供安全支持的主要方式。  
可以通过注解（定义在接口或类级别）或定义一组切入点（pointcuts）来保护方法。

[[nsa-method-security-attributes]]
=== `<method-security>` 属性

[[nsa-method-security-pre-post-enabled]]
* **pre-post-enabled**  
启用当前应用上下文中的 Spring Security 预调用和后调用注解（`@PreFilter`, `@PreAuthorize`, `@PostFilter`, `@PostAuthorize`）。  
默认值为 `"true"`。

[[nsa-method-security-secured-enabled]]
* **secured-enabled**  
启用当前应用上下文中的 Spring Security `@Secured` 注解。  
默认值为 `"false"`。

[[nsa-method-security-jsr250-enabled]]
* **jsr250-enabled**  
启用当前应用上下文中的 JSR-250 授权注解（`@RolesAllowed`, `@PermitAll`, `@DenyAll`）。  
默认值为 `"false"`。

[[nsa-method-security-mode]]
* **mode**  
如果设置为 `"aspectj"`，则使用 AspectJ 拦截方法调用。

[[nsa-method-security-proxy-target-class]]
* **proxy-target-class**  
若为 `true`，则使用基于类的代理而非基于接口的代理。  
默认值为 `"false"`。

[[nsa-method-security-security-context-holder-strategy-ref]]
* **security-context-holder-strategy-ref**  
指定用于获取 `SecurityContext` 的 `SecurityContextHolderStrategy`。  
默认值为 `SecurityContextHolder.getContextHolderStrategy()` 返回的策略。

[[nsa-method-security-observation-registry-ref]]
* **observation-registry-ref**  
对 `ObservationRegistry` 的引用，供 `FilterChain` 及相关组件使用。

[[nsa-method-security-children]]
=== `<method-security>` 的子元素

* xref:servlet/appendix/namespace/http.adoc#nsa-expression-handler[expression-handler]
* <<nsa-protect-pointcut,protect-pointcut>>

[[nsa-global-method-security]]
== `<global-method-security>`
该元素是为 Spring Security Bean 的方法提供安全支持的主要方式。  
可以通过注解（定义在接口或类级别）或通过子元素定义一组使用 AspectJ 语法的切入点来保护方法。

[[nsa-global-method-security-attributes]]
=== `<global-method-security>` 属性

[[nsa-global-method-security-access-decision-manager-ref]]
* **access-decision-manager-ref**  
方法安全使用与 Web 安全相同的 `AccessDecisionManager` 配置，但可通过此属性覆盖。  
默认使用 `AffirmativeBased` 实现，并包含 `RoleVoter` 和 `AuthenticatedVoter`。

[[nsa-global-method-security-authentication-manager-ref]]
* **authentication-manager-ref**  
对一个 `AuthenticationManager` 的引用，该管理器将用于方法级别的安全控制。

[[nsa-global-method-security-jsr250-annotations]]
* **jsr250-annotations**  
指定是否启用 JSR-250 风格的注解（例如 `"RolesAllowed"`）。  
这要求 `javax.annotation.security` 类在类路径中可用。  
设置为 `true` 时也会向 `AccessDecisionManager` 添加一个 `Jsr250Voter`，因此如果你使用自定义实现并希望支持这些注解，请确保启用此选项。

[[nsa-global-method-security-metadata-source-ref]]
* **metadata-source-ref**  
可以提供一个外部的 `MethodSecurityMetadataSource` 实例，它将优先于其他源（如默认注解）被使用。

[[nsa-global-method-security-mode]]
* **mode**  
该属性可设为 `"aspectj"`，表示应使用 AspectJ 而非默认的 Spring AOP。  
被保护的方法必须由 `spring-security-aspects` 模块中的 `AnnotationSecurityAspect` 进行织入（weave）。

请注意：AspectJ 遵循 Java 规则，即接口上的注解不会被继承。  
这意味着在接口上定义的安全注解将不会生效。  
使用 AspectJ 时，必须将安全注解放在具体类上。

[[nsa-global-method-security-order]]
* **order**  
允许设置方法安全拦截器的通知（advice）顺序。

[[nsa-global-method-security-pre-post-annotations]]
* **pre-post-annotations**  
指定是否在此应用上下文中启用 Spring Security 的预调用和后调用注解（`@PreFilter`, `@PreAuthorize`, `@PostFilter`, `@PostAuthorize`）。  
默认为 `"disabled"`。

[[nsa-global-method-security-proxy-target-class]]
* **proxy-target-class**  
若为 `true`，则使用基于类的代理而非基于接口的代理。

[[nsa-global-method-security-run-as-manager-ref]]
* **run-as-manager-ref**  
对可选的 `RunAsManager` 实现的引用，该实现将由配置的 `MethodSecurityInterceptor` 使用。

[[nsa-global-method-security-secured-annotations]]
* **secured-annotations**  
指定是否在此应用上下文中启用 Spring Security 的 `@Secured` 注解。  
默认为 `"disabled"`。

[[nsa-global-method-security-children]]
=== `<global-method-security>` 的子元素

* <<nsa-after-invocation-provider,after-invocation-provider>>
* xref:servlet/appendix/namespace/http.adoc#nsa-expression-handler[expression-handler]
* <<nsa-pre-post-annotation-handling,pre-post-annotation-handling>>
* <<nsa-protect-pointcut,protect-pointcut>>

[[nsa-after-invocation-provider]]
== `<after-invocation-provider>`
该元素可用于装饰一个 `AfterInvocationProvider`，供 `<global-method-security>` 命名空间维护的安全拦截器使用。  
你可以在 `global-method-security` 元素内定义零个或多个此类元素，每个元素通过 `ref` 属性指向应用上下文中一个实现了 `AfterInvocationProvider` 的 Bean。

[[nsa-after-invocation-provider-parents]]
=== `<after-invocation-provider>` 的父元素

* <<nsa-global-method-security,global-method-security>>

[[nsa-after-invocation-provider-attributes]]
=== `<after-invocation-provider>` 属性

[[nsa-after-invocation-provider-ref]]
* **ref**  
定义一个对实现了 `AfterInvocationProvider` 的 Spring Bean 的引用。

[[nsa-pre-post-annotation-handling]]
== `<pre-post-annotation-handling>`
允许完全替换处理 Spring Security 预调用和后调用注解（`@PreFilter`, `@PreAuthorize`, `@PostFilter`, `@PostAuthorize`）的默认表达式机制。  
仅当启用了这些注解时才生效。

[[nsa-pre-post-annotation-handling-parents]]
=== `<pre-post-annotation-handling>` 的父元素

* <<nsa-global-method-security,global-method-security>>

[[nsa-pre-post-annotation-handling-children]]
=== `<pre-post-annotation-handling>` 的子元素

* <<nsa-invocation-attribute-factory,invocation-attribute-factory>>
* <<nsa-post-invocation-advice,post-invocation-advice>>
* <<nsa-pre-invocation-advice,pre-invocation-advice>>

[[nsa-invocation-attribute-factory]]
== `<invocation-attribute-factory>`
定义用于从带注解的方法生成预调用和后调用元数据的 `PrePostInvocationAttributeFactory` 实例。

[[nsa-invocation-attribute-factory-parents]]
=== `<invocation-attribute-factory>` 的父元素

* <<nsa-pre-post-annotation-handling,pre-post-annotation-handling>>

[[nsa-invocation-attribute-factory-attributes]]
=== `<invocation-attribute-factory>` 属性

[[nsa-invocation-attribute-factory-ref]]
* **ref**  
定义对一个 Spring Bean ID 的引用。

[[nsa-post-invocation-advice]]
== `<post-invocation-advice>`
使用 `ref` 所引用的 `PostInvocationAuthorizationAdvice` 来定制 `<pre-post-annotation-handling>` 元素中的 `PostInvocationAdviceProvider`。

[[nsa-post-invocation-advice-parents]]
=== `<post-invocation-advice>` 的父元素

* <<nsa-pre-post-annotation-handling,pre-post-annotation-handling>>

[[nsa-post-invocation-advice-attributes]]
=== `<post-invocation-advice>` 属性

[[nsa-post-invocation-advice-ref]]
* **ref**  
定义对一个 Spring Bean ID 的引用。

[[nsa-pre-invocation-advice]]
== `<pre-invocation-advice>`
使用 `ref` 所引用的 `PreInvocationAuthorizationAdvice` 来定制 `<pre-post-annotation-handling>` 元素中的 `PreInvocationAuthorizationAdviceVoter`。

[[nsa-pre-invocation-advice-parents]]
=== `<pre-invocation-advice>` 的父元素

* <<nsa-pre-post-annotation-handling,pre-post-annotation-handling>>

[[nsa-pre-invocation-advice-attributes]]
=== `<pre-invocation-advice>` 属性

[[nsa-pre-invocation-advice-ref]]
* **ref**  
定义对一个 Spring Bean ID 的引用。

[[nsa-protect-pointcut]]
== 使用 `<protect-pointcut>` 保护方法
除了使用 `@Secured` 注解逐个方法或类地定义安全属性外，还可以使用 `<protect-pointcut>` 元素，在服务层中跨多个方法和接口定义横切的安全约束。  
你可以在 xref:servlet/authorization/method-security.adoc#ns-protect-pointcut[命名空间介绍] 中找到示例。

[[nsa-protect-pointcut-parents]]
=== `<protect-pointcut>` 的父元素

* <<nsa-global-method-security,global-method-security>>
* <<nsa-method-security,method-security>>

[[nsa-protect-pointcut-attributes]]
=== `<protect-pointcut>` 属性

[[nsa-protect-pointcut-access]]
* **access**  
适用于匹配该切入点的所有方法的访问配置属性列表，例如：`"ROLE_A,ROLE_B"`

[[nsa-protect-pointcut-expression]]
* **expression**  
一个 AspectJ 表达式，包含 `execution` 关键字。  
例如：`execution(int com.foo.TargetObject.countLength(String))`

[[nsa-intercept-methods]]
== `<intercept-methods>`
可在 Bean 定义内部使用，为该 Bean 添加安全拦截器，并为其方法设置访问控制配置属性。

[[nsa-intercept-methods-attributes]]
=== `<intercept-methods>` 属性

[[nsa-intercept-methods-use-authorization-manager]]
* **use-authorization-manager**  
使用 AuthorizationManager API 而非 AccessDecisionManager（默认为 `true`）

[[nsa-intercept-methods-authorization-manager-ref]]
* **authorization-manager-ref**  
可选的 AuthorizationManager Bean ID，用于替代默认实现（优先级高于 use-authorization-manager）

[[nsa-intercept-methods-access-decision-manager-ref]]
* **access-decision-manager-ref**  
可选的 AccessDecisionManager Bean ID，供创建的方法安全拦截器使用。

[[nsa-intercept-methods-children]]
=== `<intercept-methods>` 的子元素

* <<nsa-protect,protect>>

[[nsa-method-security-metadata-source]]
== `<method-security-metadata-source>`
创建一个 `MethodSecurityMetadataSource` 实例。

[[nsa-method-security-metadata-source-attributes]]
=== `<method-security-metadata-source>` 属性

[[nsa-method-security-metadata-source-id]]
* **id**  
Bean 标识符，用于在上下文中其他位置引用该 Bean。

[[nsa-method-security-metadata-source-use-expressions]]
* **use-expressions**  
启用在 `<intercept-url>` 元素的 `access` 属性中使用表达式，而不是传统的配置属性列表。  
默认为 `'false'`。  
若启用，每个属性应包含一个布尔表达式；若表达式求值为 `'true'`，则授予访问权限。

[[nsa-method-security-metadata-source-children]]
=== `<method-security-metadata-source>` 的子元素

* <<nsa-protect,protect>>

[[nsa-protect]]
== `<protect>`
定义受保护的方法及其适用的访问控制配置属性。  
我们强烈建议不要将 `<protect>` 声明与 `global-method-security` 提供的服务混合使用。

[[nsa-protect-parents]]
=== `<protect>` 的父元素

* <<nsa-intercept-methods,intercept-methods>>
* <<nsa-method-security-metadata-source,method-security-metadata-source>>

[[nsa-protect-attributes]]
=== `<protect>` 属性

[[nsa-protect-access]]
* **access**  
应用于该方法的访问配置属性列表，例如：`"ROLE_A,ROLE_B"`

[[nsa-protect-method]]
* **method**  
方法名称